## Miscellaneous notes:

- Sorry, this file is quite a mess. It's for my own future reference. These notes are not in any particular order.
- jpdict is always unavailable (dbState and getDataSeriesStatus in jpdict.ts), we only use flat file dict. But we still keep all the old code, not have time yet to prune them.
  - when ever the flat file dict is loaded, it will notify its updated state to other listeners. Check jpdict.ts initDb function.
- in many places, variables are used for new purposes but still keep the original names: (actually some of these are fixed, some completely, some partially)
  - wanikani -> hsk, bunpro -> tocfl, priority -> show hanviet transliteration, accent display -> hanzi display order (binary -> simp before trad, binary-hi-contrast: simp only; downstep: trad before simp; none: trad only), romaji -> pinyinDisplay
  - copy entry -> copy, copy-separate fields -> search images; copy words -> disabled
  - kanji tab -> stroke order
- to change config default, must change both getters and setters. Because this project's style is to delete settings key if it's the same as the default config. For detail check config.ts
- strokes order uses kanji tab: the data is populated not from dictionary search phase but from render phase. Check render-popup.ts
- disabled from 10ten: metadata (shogi, currency, era, number, measure), Image search, title search, horizontal swiping, downwards arrow, context menu (toggle on off/enable puck), names tab, tap to lookup, jpdict IDB download/updating, fx data, kanji tab content
- if you want to use bugsnag, should replace in file "secrets.ts": MY_BUGSNAG_API_KEY
  - First replace `bugsnag_api_key_placeholder` in `src/utils/secrets.ts` with your Bugsnag API key. You can run `git update-index --assume-unchanged src/utils/secrets.ts` to prevent it from being shown in diffs and from being committed.
  - to hide from git status: git update-index --assume-unchanged ./src/utils/secrets.ts
  - to undo: git update-index --no-assume-unchanged ./src/utils/secrets.ts
- flat file dict mechanism:
  - read from u8 and idx file
  - create raw records; then convert to proper record to process. Check flat-file.ts for the record format. We are using 10ten's format to store our dict so many fields are not used.
  - FlatFileDatabaseLoader is the wrapper around flatFileDatabase.
    - it holds a lang field. When the dictLang change, it will dump the current lang and current flat file database and adopt the new lang. Then on the next load (await fallbackDatabaseLoader.database; when its loadState is 'unload' will load the new flat file database) it will load the new flat file database of the new lang.
- to enable enable puck context menu, uncomment related code and add permssion "contextMenus" in manifest.json
- pnpm commands:
  - pnpm check-keys: check for missing/extra keys and if passed, to see important keys
    - currently in \_locales/ dir we hold a lot of unused keys from 10ten. So it's neccessary to just look through the important keys.
  - to build:
    - pnpm install --frozen-lockfile
    - chrome: pnpm build:chrome
    - safari:
      - pnpm build:safari
      - in xcode: add the project under xcode13
      - use xcode to build to devices.
  - to update a package after changing package version in package.json:
    - pnpm install <package-name>
  - pass CI:
    - to test:
      - pnpm test
      - pnpm playwright-test "tests/\*\*/\*.test.ts" --browser chromium
      - somehow pnpm playwright-test "tests/\*\*/\*.test.ts" --browser firefox fails while the chromium one passed. But on Github both passed so no worry, perhaps it's just a local problem. As long as chromium passed locally, it's fine.
    - pnpm lint
  - pnpm version:
    - the root version is in package.json, you only need to set the version here. This is to sync this version number to manifest.json and xcode project file. Also, the xcode build number will be +=1
      - this is actually a special script that typically runs automatically when you update your package version (like when running pnpm version patch or pnpm version minor).
        - pnpm version patch # for a bug fix (1.0.1 -> 1.0.2)
        - pnpm version minor # for new features (1.0.1 -> 1.1.0)
        - pnpm version major # for breaking changes (1.0.1 -> 2.0.0)
  - command list is declared in package.json
    - devDependencies: only used for development purposes
- packages and tools:
  - knip: useful tool for finding unused code
  - husky: looks like it's for doing things at commit time, like formatting
  - depends on hanviet-pinyin-words. Everytime we update that package, must run "pnpm update hanviet-pinyin-words" here.
- cedict.idx separators must be space: because space has the lowest unicode value, it will always be sorted first, so that A\<separator\> will always be before AB... This is needed in flat-file's findNeedle function. For example, if the separator is e.g. \_, then cannot find 来 because, then 来\_ will be sorted after 来M (also in the dict) while actually 来 (1 char) should be sorted before 来M (2 chars)
- data dir:
  - including all our dicts + stroke order data
  - if a char is not found in the stroke order data, a char not found message will be shown.
- rspack:
  - this is the actual build place config: determines which files to copy into final build
  - you can swap module here:
    - for example: by default 10ten uses activeTabOnly: true in Safari, here I changed it to activeTabOnly: false,
      - this will use all-tab-manager instead of active-tab-manager. Which will avoid the need for always having to enable the extension with every new tab or new web page.
- currently dictLang is set by default to the locale of users:
  - locales are set by OS language or browser language, we cannot set it manually
  - there are 3 locales: en, vi, zh. Locale determines UI language. (UI language is different from dict language). But if users in en and vi locale, which is inside DbLanguageId, then we use 'en' or 'vi' language dict. Check get default dict lang in config.ts
- default hanvietDisplay also depends on the locale. if it's vi, then default is true
- when update cedict data:
  - download new cedict .u8 file. Usually it's CRLF. Must config it to be CRLF in .gitattributes to keep its CRLF
    - convert it to LF is also ok, but we have to generate its idx file again
    - we keep it this CRLF way because it's the default format of CEDICT
    - for the dict to work, it must have its true line ending format because the idx file counts the number of bytes in u8 file
  - to generate idx files: use scripts/generate_idx.py. Check the parameters
- we have hsk.ts and tocfl.ts as 2 database for checking if a word is inside those list
  - they are minified so they are inside .prettierignore
    - they are generated by two other local projects.
- TODOP is our TODOs, TODO is original project's TODO
- I have deleted to the best of my knowledge all URL call so that this project is strictly offline, except Bugsnag (not properly config yet). All the FX, jpdict download have been disabled (even though the source file is still there, not deleted yet).
- test cases: is not full. Have not covered our project's new features.
- font: use NOTO sans SC (simplified) of google. Not sure if we should get the traditional version. But this font's coverage is guaranteed to be huge.
- hanviet depends on having pinyin. Pinyin is in fact romaji in the background.
  - But if we disable romaji in the config, then the background.ts will not send romaji (pinyin) info content.ts (foreground) so we cannot display hanviet
  - So, therefore, romaji must always be enabled in order for hanviet to work.
- To debug:
  - service worker / background page or settings page:
    - will debug background.ts
    - To show current settings:
      - chrome.storage.sync.get(console.log)
      - chrome.storage.local.get(console.log)
  - current web page:
    - will debug content.ts
- To generate icons:
  - pnpm exec tsx scripts/generate-icons.ts
  - inside that file create2Path function is used to generate svg path.
  - you can use that function to generate svg path for puck icon inside puck.ts also
  - python script with same function is in scripts/generate_svg_icon.py
- picasso project structure:
  - app store:
    - main variant - iphone ipad mac - english
    - vn variant - iphone ipad mac - vietnamese
  - chrome store:
    - desktop-browser-EN - mac - english --> resized to half
    - desktop-browser-VI - mac - vietnamese --> resized to half
  - firefox:
    - firefox-EN - mac - english -> cropped to 2400x1800
    - firefox-VI - mac - vietnamese -> cropped to 2400x1800
  - all variants share same font type and color palette and xcstrings file
- Firefox temporarily install addon from local source:
  - In Firefox: Open the about:debugging page, click the This Firefox option, click the Load Temporary Add-on button, then select any file in your extension's directory.
  - The extension now installs, and remains installed until you restart Firefox.
- charsData:
  - all fields are separated by underscore, null fields are empty string so they makes two consecutive underscores
  - common guarantees: no FIELD_SEPARATOR in any field (FIELD_SEPARATOR only used as separator). Item in list does not contain LIST_SEPARATOR
  - main char: never empty, guaranteed to be of length 1, non-whitespace string, unique
  - pinyin: never empty, at least one pinyin, if multiple, separated by comma without space. Ordered by most popular to least popular (if have frequency data)
  - gloss: can be empty, if not empty, it's always non-whitespace string
  - hint: can be empty, if not empty, it's always non-whitespace string
  - trad_variants: can be empty, if not empty, it's always non-whitespace string: at least one trad character of length 1 separated by comma without space
  - strokeCount: empty or guaranteed to be an integer > 0
  - bookCharRank: empty or guaranteed to be an integer > 0
  - radical_str:
    - case 1: empty. Means no radical.
    - case 2: "\*". Means itself is a radical. Guaranteed to have non-empty gloss and gloss_vi
    - case 3: non-empty, with 2 components separated by COMPONENT_SEPARATOR: radical|gloss . Each component is guaranteed to be non-empty. Radical is guaranteed to be different from char and of length 1.
- chardData unavailable fields:
  - simp_variants: can be empty, if not empty, it's always non-whitespace string: at least one simp character of length 1 separated by comma without space
  - variantOf: can be empty, if not empty, it's always length 1 non whitespace character, different from main char
  - isVerified: empty or 1
  - movieCharRank: empty or guaranteed to be an integer > 0
  - movieCharContextsPercent: empty or guaranteed to be 0 < a float <= 1 with max 4 decimal places. It does not have trailing 0 or trailing decimal point (in case 1)
  - components: can be empty, if not empty, it's a list of components of at least 1 component. Each component is separated by COMPONENT_SEPARATOR, inside each component, fields are separated by SUBCOMPONENT_SEPARATOR.
    - First field is character, always available, always length 1, non whitespace.
    - Second field is type, always available, always a list of at least 1 type, each type must be one of these: 'unknown', 'deleted', 'remnant', 'iconic', 'meaning', 'distinguishing', 'simplified', 'sound' separated by LIST_SEPARATOR
    - Third field is hint, can be empty, if not empty, it's always non whitespace string
    - 4th,5th,6th fields are isOldPronunciation, isGlyphChanged, isFromOriginalMeaning, all can be empty, if not empty, must be 0 or 1
- char_en.txt: generated from dong-chinese.com data
  - we must process this file in background rather than content because it's too big. And safari ios doesn't accept content.js > 4MB
- generate idx file: scripts/generate_idx.py
  - for each line in cedict: get all possible characters including both simp and trad. Then assign all of them to each word in that line. Then with each char, if they are available in char.txt, then include its index in char.txt, associated with that word.
  - so, it can happen that sometimes a char is not found in char.txt, meaning that word will not have that char's associated data.
- RawWordRecord:
  - k: simp char, trad char (only these 2)
  - km:
    - p: pField, (always ['bg1'], can have 'wkLevel' (HSK) or 'bvLevel' (TOCFL))
    - bg: characters data, including possible simp, trad chars' data. Can be empty string, or single line or multiple lines separated by \n
  - r: pinyin
  - s:
    - g: [definition],
- After converted to toDictionaryWordResult:
  - k: 2 fields:
    - first field: simp
      - ent: character
      - has metadata like:
        - wk (can have or not): HSK level
        - bv (can have or not): {l: level}
        - bg:
          - l: always 1
          - src (can have or not): characters data string with \n inside (if multiple characters)
            - If raw bg is empty string then there is no src here
            - if src is available, it's always non-empty string
      - match: true or false depending on if this char matches the search input
    - second field: trad
      - ent: character
      - don't have metadata
      - match: true or false depending on if this char matches the search input
